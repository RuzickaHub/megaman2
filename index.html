<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{SITE_NAME}</title>
    <script src="https://cdn.jsdelivr.net/npm/marked@16.4.1/lib/marked.umd.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.11.1/highlight.min.js"></script>
    <link id="hljs-light" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.11.1/styles/default.min.css">
    <link id="hljs-dark" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.11.1/styles/dracula.min.css" disabled>
    
    <style>
        /* --- OPTIMALIZACE: Plynulé přechody pro Dark Mode --- */
        :root{--bg:#f8f9fa;--fg:#212529;--bg-card:#fff;--border:#dee2e6;--hover:#f8f9fa;--select:#e3f2fd;--primary:#0d6efd;--spinner:var(--primary);--toggle:#6c757d;}
        body.dark{--bg:#0a0a0a;--fg:#f8f9f9;--bg-card:#161616;--border:#333;--hover:#1f1f1f;--select:#1e40af;--primary:#3b82f6;--spinner:var(--primary);--toggle:#adb5bd;}
        *{margin:0;padding:0;box-sizing:border-box;}
        body{
            font-family:system-ui,sans-serif;background:var(--bg);color:var(--fg);height:100vh;overflow:hidden;display:flex;flex-direction:column;
            transition: background-color 0.3s, color 0.3s; /* Plynulý přechod */
        }
        .topbar, .sidebar, .content {
             transition: background-color 0.3s, border-color 0.3s; /* Plynulý přechod */
        }
        .topbar{display:flex;align-items:center;padding:0 1rem;height:60px;background:var(--bg-card);border-bottom:1px solid var(--border);flex:none;z-index:10;}
        #menu-btn{display:none;background:none;border:none;font-size:1.5rem;cursor:pointer;padding:.5rem;color:var(--fg);}
        #site-title{margin:0 1rem;font-size:1.2rem;flex:1;}
        .topbar-right{display:flex;align-items:center;gap:.5rem;}
        #search{padding:.5rem .75rem;border:1px solid var(--border);border-radius:.375rem;background:var(--bg-card);color:var(--fg);}
        #theme-toggle{border:none;background:none;font-size:1.25rem;cursor:pointer;padding:.5rem;border-radius:.25rem;transition:.2s;}
        #theme-toggle:hover{background:var(--hover);}
        .main{flex:1;display:flex;overflow:hidden;position:relative;}
        .sidebar{width:280px;background:var(--bg-card);border-right:1px solid var(--border);overflow:auto;position:relative;}
        #fileTree{list-style:none;}
        .tree-item{cursor:pointer;user-select:none;display:flex;align-items:center;padding:.5rem 1rem;transition:.2s;}
        .tree-item:hover{background:var(--hover);}
        .tree-item.active{background:var(--select);border-left:3px solid var(--primary);font-weight:500;}
        .toggle{margin-right:.5rem;width:1rem;text-align:center;color:var(--toggle);transition:.2s;}
        .name{flex:1;}
        .children{padding-left:1.5rem;display:none;}
        .tree-item.open > .children{display:block;}
        .content{flex:1;padding:2rem;overflow:auto;background:var(--bg-card);}
        .loading{text-align:center;padding:3rem 1rem;color:var(--fg);}
        .spinner{margin:0 auto 1rem;width:3rem;height:3rem;border:3px solid var(--border);border-top-color:var(--spinner);border-radius:50%;animation:spin 1s linear infinite;}
        @keyframes spin{to{transform:rotate(360deg)};}
        .doc-title{margin-bottom:2rem;color:var(--fg);border-bottom:2px solid var(--border);padding-bottom:.5rem;}
        .overlay{display:none;position:fixed;top:60px;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:99;}
        @media(max-width:768px){#menu-btn{display:block;}.sidebar{position:fixed;top:60px;left:0;bottom:0;width:280px;z-index:100;transform:translateX(-100%);transition:transform .3s ease;}body.sidebar-open .sidebar{transform:translateX(0);}body.sidebar-open .overlay{display:block;}.content{padding:1.5rem;}}
    </style>
</head>
<body>
    <header class="topbar">
        <button id="menu-btn">Menu</button>
        <h1 id="site-title">{SITE_NAME}</h1>
        <div class="topbar-right">
            <input type="text" id="search" placeholder="Vyhledat...">
            <button id="theme-toggle">Moon</button>
        </div>
    </header>
    <div class="overlay" id="overlay"></div>
    <div class="main">
        <nav class="sidebar" id="sidebar">
            <ul id="fileTree"></ul>
        </nav>
        <main class="content" id="content">
            <div class="loading">
                <div class="spinner"></div>
                <p>Načítám...</p>
            </div>
        </main>
    </div>

    <script>
        // === KONFIGURACE A PŘESMĚROVÁNÍ ===
        const OWNER = localStorage.getItem('OWNER');
        const REPO = localStorage.getItem('REPO');
        const BRANCH = localStorage.getItem('BRANCH');
        const ROOT_PATH = localStorage.getItem('ROOT_PATH') || '';
        const SITE_NAME = localStorage.getItem('SITE_NAME');
        const DEFAULT_FILE = 'README.md';

        if (!OWNER || !REPO || !BRANCH) {
            document.body.innerHTML = '<div style="text-align: center; padding: 50px;"><h1>Nastavení Chybí</h1><p>Prosím, nejprve nastavte konfiguraci. Budete přesměrováni...</p></div>';
            setTimeout(() => {
                window.location.href = 'start-setup.html'; 
            }, 1000);
            throw new Error("Missing configuration. Redirecting to setup."); 
        }

        document.title = SITE_NAME;
        document.getElementById('site-title').textContent = SITE_NAME;

        const API_BASE = `https://api.github.com/repos/${OWNER}/${REPO}/contents`;
        const RAW_BASE = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}`;
        let tree = [];
        
        // ===================================
        // === CORE LOGIKA DOKUMENTACE S KEŠOVÁNÍM ===

        // Funkce pro generování kešovacího klíče
        function getCacheKey(path) {
            return `doc_cache_${OWNER}_${REPO}_${BRANCH}_${path}`;
        }
        
        // Načte adresářovou strukturu (s kešováním pro rychlou inicializaci)
        async function fetchFiles(path = '') {
            try {
                const url = ROOT_PATH ? `${API_BASE}/${ROOT_PATH}/${path}` : `${API_BASE}/${path}`;
                const res = await fetch(`${url}?ref=${BRANCH}`);
                
                if (!res.ok) {
                     document.getElementById('content').innerHTML = `<div class="loading"><p>Chyba při načítání adresářové struktury: ${res.status} ${res.statusText}.</p><p>Zkontrolujte nastavení ROOT_PATH a zda je repozitář veřejný.</p></div>`;
                     return [];
                }

                const data = await res.json();
                return Array.isArray(data) ? data.filter(item => 
                    item.type === 'file' && item.name.endsWith('.md') || item.type === 'dir'
                ).sort((a,b) => {
                    if (a.type !== b.type) return a.type === 'dir' ? -1 : 1;
                    return a.name.localeCompare(b.name);
                }) : [];
            } catch (e) { console.error(e); return []; }
        }

        async function buildTree(path = '', depth = 0) {
            const items = await fetchFiles(path);
            const nodes = [];
            
            // Optimalizace: Použití Promise.all pro paralelní načítání podadresářů (pokud je to možné)
            const promises = items.map(async item => {
                if (item.type === 'dir') {
                    const children = await buildTree(item.path, depth + 1);
                    return { type: 'dir', name: item.name, path: item.path, children, depth, open: false };
                } else {
                    return { type: 'file', name: item.name.replace('.md',''), path: item.path, depth };
                }
            });

            return Promise.all(promises);
        }

        function renderTree(nodes, parent) {
            nodes.forEach(node => {
                const li = document.createElement('li');
                li.className = 'tree-item';
                if (node.type === 'dir') li.classList.add(node.open ? 'open' : 'collapsed');
                const toggle = node.type === 'dir' ? `<span class="toggle">${node.open ? '▼' : '▶'}</span>` : '<span class="toggle"></span>';
                li.innerHTML = `${toggle}<span class="name" data-path="${node.path}">${node.name}</span>`;
                if (node.type === 'dir') {
                    const ul = document.createElement('ul');
                    ul.className = 'children';
                    renderTree(node.children, ul);
                    li.appendChild(ul);
                }
                parent.appendChild(li);
            });
        }

        function reHighlight() {
            document.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
        }

        // Načtení souboru (S KEŠOVÁNÍM)
        async function loadFile(path) {
            const content = document.getElementById('content');
            content.innerHTML = `<div class="loading"><div class="spinner"></div><p>Načítám...</p></div>`;
            
            const cacheKey = getCacheKey(path);
            let md = sessionStorage.getItem(cacheKey); // 1. Zkusit načíst z keše

            if (!md) {
                const cleanPath = path.startsWith('/') ? path.substring(1) : path;
                const finalUrl = `${RAW_BASE}/${cleanPath}`;

                try {
                    const res = await fetch(finalUrl);
                    
                    if (!res.ok) {
                        throw new Error(`Chyba při stahování souboru. HTTP Status: ${res.status} ${res.statusText}`);
                    }
                    
                    md = await res.text();
                    sessionStorage.setItem(cacheKey, md); // 2. Uložit do keše
                } catch (e) {
                    console.error(e);
                    content.innerHTML = `<div class="loading"><p>
                        Chyba: Nepodařilo se načíst soubor.
                        <br>Adresa, která selhala: <strong>${finalUrl}</strong>
                        <br>Detaily chyby: ${e.message}
                    </p></div>`;
                    return; 
                }
            }
            
            // Převod Markdownu na HTML a zobrazení
            const title = path.split('/').pop().replace('.md', '');
            
            if (typeof marked === 'undefined' || marked === null) {
                // Toto by se nemělo stát, ale je to dobrý fallback
                content.innerHTML = `<div class="loading"><p>Chyba: Knihovna Marked.js není načtena.</p></div>`;
                return;
            }
            
            content.innerHTML = `<h1 class="doc-title">${title}</h1>` + marked.parse(md, { gfm: true, breaks: false });
            reHighlight();
            content.scrollTop = 0;
            
            document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`[data-path="${path}"]`)?.closest('.tree-item')?.classList.add('active');
        }

        // Theme a Events (beze změny, funkční)

        let isDark = localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);
        document.body.classList.toggle('dark', isDark);
        document.getElementById('theme-toggle').textContent = isDark ? 'Sun' : 'Moon';
        const lightLink = document.getElementById('hljs-light');
        const darkLink = document.getElementById('hljs-dark');
        
        function setHighlightStyles() {
            lightLink.disabled = isDark;
            darkLink.disabled = !isDark;
            reHighlight();
        }
        setHighlightStyles();

        function toggleTheme() {
            isDark = !isDark;
            document.body.classList.toggle('dark', isDark);
            document.getElementById('theme-toggle').textContent = isDark ? 'Sun' : 'Moon';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            setHighlightStyles();
        }

        document.getElementById('theme-toggle').onclick = toggleTheme;
        
        // --- OPTIMALIZACE: Vylepšené vyhledávání v názvu a cestě ---
        document.getElementById('search').oninput = e => {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('.name').forEach(el => {
                const path = el.dataset.path?.toLowerCase() || '';
                const name = el.textContent.toLowerCase();

                // Zobrazit, pokud se termín shoduje s názvem NEBO s celou cestou
                const show = term === '' || name.includes(term) || path.includes(term);
                el.closest('.tree-item').style.display = show ? '' : 'none';

                // Bonus: Rozbalit složky obsahující nalezený soubor
                if (show) {
                    let parent = el.closest('.children');
                    while (parent) {
                        const li = parent.closest('.tree-item');
                        if (li && !li.classList.contains('open')) {
                            li.classList.add('open');
                            li.classList.remove('collapsed');
                            const toggle = li.querySelector('.toggle');
                            if(toggle) toggle.textContent = '▼';
                        }
                        parent = li?.closest('.children');
                    }
                }
            });
        };
        // -----------------------------------------------------------
        
        document.getElementById('menu-btn').onclick = () => document.body.classList.toggle('sidebar-open');
        document.getElementById('overlay').onclick = () => document.body.classList.remove('sidebar-open');
        document.getElementById('fileTree').onclick = e => {
            const toggle = e.target.closest('.toggle');
            if (toggle && toggle.parentElement.classList.contains('tree-item')) {
                const li = toggle.parentElement;
                const open = li.classList.toggle('open');
                li.classList.toggle('collapsed', !open);
                toggle.textContent = open ? '▼' : '▶';
                return;
            }
            const name = e.target.closest('.name');
            if (name && name.dataset.path.endsWith('.md')) {
                loadFile(name.dataset.path);
                if (window.innerWidth < 768) document.body.classList.remove('sidebar-open');
            }
        };

        // Init (S KEŠOVÁNÍM STRUKTURY)
        async function init() {
            const treeCacheKey = `doc_tree_${OWNER}_${REPO}_${BRANCH}_${ROOT_PATH}`;
            const cachedTree = sessionStorage.getItem(treeCacheKey);

            if (cachedTree) {
                tree = JSON.parse(cachedTree);
            } else {
                tree = await buildTree(ROOT_PATH);
                sessionStorage.setItem(treeCacheKey, JSON.stringify(tree)); // Uložit novou strukturu
            }

            const treeEl = document.getElementById('fileTree');
            renderTree(tree, treeEl);
            
            const flatTree = tree.flatMap(n => n.type === 'file' ? [n] : n.children || []).filter(f => f.type === 'file');
            
            const defaultFile = flatTree.find(f => f.path.toLowerCase().endsWith(DEFAULT_FILE.toLowerCase())) || flatTree[0];
            
            if (defaultFile) {
                loadFile(defaultFile.path);
            } else if (tree.length > 0) {
                 document.getElementById('content').innerHTML = `<div class="loading">
                     <p>Repozitář obsahuje složky, ale v adresáři ${ROOT_PATH || '/'} nebyly nalezeny žádné .md soubory.</p>
                     <p>Procházejte menu vlevo.</p>
                 </div>`;
            } else {
                 document.getElementById('content').innerHTML = `<div class="loading">
                     <p>Chyba: Repozitář je prázdný nebo neobsahuje žádné .md soubory ve specifikovaném adresáři (${ROOT_PATH || '/'}).</p>
                 </div>`;
            }
        }
        
        if (OWNER && REPO && BRANCH) {
            init();
        }
    </script>
</body>
</html>
